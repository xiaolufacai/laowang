{include file="/layout/header" /}

<div id="app" style="background-color: #ffffff">
	<el-container>
		<el-header style="text-align: right; font-size: 12px">
			<el-form :inline="true" ref="searchForm" :model="formInline" class="demo-form-inline">
				<el-form-item>
					<el-input v-model="formInline.orderId" placeholder="请输入订单ID"></el-input>
				</el-form-item>
				<el-form-item>
					<el-select v-model="formInline.app" @change="select" placeholder="APP">
						<el-option
								v-for="(item,index) in apps"
								:key="index"
								:label="item.project"
								:value="item.app_id">
						</el-option>
					</el-select>
				</el-form-item>
				<el-form-item>
					<el-button type="primary" @click="searchOrders">搜索</el-button>
				</el-form-item>
			</el-form>
		</el-header>

		<el-main>
			<el-table :data="tableData" border style="width: 1331px">
				<el-table-column align="center" prop="id" label="ID" width="80"></el-table-column>
				<el-table-column align="center" prop="create_time" label="创建时间" width="170"></el-table-column>
				<el-table-column align="center" prop="mobile_brand" label="手机品牌" width="100"></el-table-column>
				<el-table-column align="center" prop="mobile_model" label="手机型号" width="170"></el-table-column>
				<el-table-column align="center" prop="vip_type_txt" label="会员类型" width="150"></el-table-column>
				<el-table-column align="center" prop="vip_create_time" label="会员创建时间" width="170"></el-table-column>
				<el-table-column align="center" prop="vip_time" label="会员到期时间" width="170"></el-table-column>
				<el-table-column align="center" prop="channel_txt" label="注册渠道" width="120"></el-table-column>
				<el-table-column align="center" width="200" label="操作">
					<template slot-scope="scope">
						<el-button size="normal" @click="openVipDialog(scope.row)">设置会员</el-button>
					</template>
				</el-table-column>
			</el-table>

			<!-- Pagination -->
			<el-pagination class="el-pagination-page"
			               v-if="totalItems > 0"
			               @current-change="handlePageChange"
			               :current-page="currentPage"
			               :page-size="pageSize"
			               :total="totalItems"
			               layout="total, prev, pager, next, jumper">
			</el-pagination>
		</el-main>

		<!-- 设置会员弹窗 -->
		<el-dialog title="设置会员" :visible.sync="vipDialogVisible" width="400px">
			<el-form :model="vipForm" label-width="100px">
				<el-form-item label="会员类型">
					<el-select v-model="vipForm.vip_type" placeholder="请选择会员类型">
						<el-option
								v-for="(label, key) in vipTypes"
								:key="key"
								:label="label"
								:value="key">
						</el-option>
					</el-select>
				</el-form-item>
				<el-form-item label="到期时间">
					<el-date-picker
							v-model="vipForm.vip_time"
							type="datetime"
							placeholder="选择到期时间"
							value-format="yyyy-MM-dd HH:mm:ss">
					</el-date-picker>
				</el-form-item>
			</el-form>
			<template #footer>
				<el-button @click="vipDialogVisible = false">取消</el-button>
				<el-button type="primary" @click="submitVip">提交</el-button>
			</template>
		</el-dialog>
	</el-container>
</div>

<style>
	.diy-el-form {
		background-color: #fff;
	}
	.demo-form-inline {
		margin-top: 10px;
	}
	.el-header {
		background-color: #e7ebf0;
		color: #333;
		line-height: 60px;
	}
	.el-aside {
		color: #333;
	}
	.el-pagination-page {
		margin-top: 10px;
	}
</style>
<script type="module" src="/static/admin/js/date.js"></script>
<script type="module">
	import {formatTimestamp} from '/static/admin/js/date.js'
	var Main = {
		data() {
			return {
				formInline: {
					app: '',
					orderId: ''
				},
				apps: [],
				tableData: [],
				currentPage: 1,
				pageSize: 10,
				totalItems: 0,
				vipTypes: {},
				vipDialogVisible: false,
				vipForm: {
					user_id: null,
					vip_type: '',
					vip_time: ''
				}
			}
		},
		created() {
			this.getApps();
			this.getVips()
		},
		methods: {
			searchOrders() {
				this.getAppOrders(this.formInline.app, this.formInline.orderId, this.currentPage);
			},
			handlePageChange(page) {
				this.currentPage = page;
				this.getAppOrders(this.formInline.app, this.formInline.orderId, page);
			},
			getApps() {
				let _this = this;
				axios.get('/admin/app/apps')
						.then(response => {
							const data = response.data.data;
							if (response.data.code === 0) {
								_this.apps = data;
								if (_this.apps.length > 0) {
									_this.formInline.app = _this.apps[0].id;
									_this.getAppOrders(_this.formInline.app, '', _this.currentPage);
								}
							}
						}).catch(() => {
					_this.$message({ message: '数据获取失败', type: 'error' });
				});
			},
			getAppOrders(appId, orderId, page) {
				let _this = this;
				axios.get('/admin/user/users', {
					params: {
						app_id: appId,
						order_id: orderId,
						page: page,
						page_size: _this.pageSize
					}
				}).then(response => {
					const data = response.data.data;
					if (response.data.code === 0) {
						_this.tableData = data.data;
						_this.totalItems = data.total;
					} else {
						_this.tableData = [];
						_this.totalItems = 0;
					}
				}).catch(() => {
					_this.$message({ message: '数据获取失败', type: 'error' });
				});
			},
			select(id) {
				this.formInline.app = id;
				this.getAppOrders(id, this.formInline.orderId, this.currentPage);
			},
			openVipDialog(row) {
				this.vipForm.user_id = row.id;
				this.vipForm.vip_type = row.vip_type || '';
				// 自动格式化 vip_time（如果是时间戳则转换）
				if(!row.vip_time) {
					this.vipForm.vip_time = formatTimestamp(Math.floor(Date.now() / 1000));
				}else {
					this.vipForm.vip_time = row.vip_time || '';
				}
				this.vipDialogVisible = true;
			},
			submitVip() {
				const { user_id, vip_type, vip_time } = this.vipForm;
				if (!vip_type || !vip_time) {
					this.$message.warning('请填写完整信息');
					return;
				}
				axios.post('/admin/user/setUserVip', {
					user_id,
					vip_type,
					vip_time
				}).then(response => {
					if (response.data.code === 0) {
						this.$message.success('设置成功');
						this.vipDialogVisible = false;
						this.getAppOrders(this.formInline.app, this.formInline.orderId, this.currentPage);
					} else {
						this.$message.error(response.data.message || '设置失败');
					}
				}).catch(() => {
					this.$message.error('接口请求失败');
				});
			},
			getVips() {
				let _this = this;
				axios.get('/admin/configs/vips', {
				}).then(response => {
					const data = response.data.data;
					if (response.data.code === 0) {
						_this.vipTypes = data;
					} else {
						_this.vipTypes = {};
					}
				}).catch(() => {
					_this.$message({ message: '数据获取失败', type: 'error' });
				});
			},
		}
	}

	var Ctor = Vue.extend(Main)
	new Ctor().$mount('#app')
</script>


{include file="/layout/footer" /}

